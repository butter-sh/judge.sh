# judge.sh Testing Framework

A bash testing framework with snapshot support, generated by hammer.sh.

## Quick Start

```bash
# 1. Make scripts executable
./setup.sh

# 2. Run the example test
./examples/basic_test.sh

# 3. Initialize snapshots for test runner
./judge.sh setup

# 4. Run all tests
./judge.sh run
```

## Features

- ðŸ§ª **Comprehensive Test Framework** - Full assertion library
- ðŸ“¸ **Snapshot Testing** - Capture and validate test outputs
- ðŸŽ¯ **Command Delegation** - Clean CLI with specialized sub-commands
- ðŸ“Š **Test Reporting** - Detailed test summaries and statistics
- ðŸ”§ **Easy Setup** - Quick initialization and configuration

## Project Structure

```
judge.sh/
â”œâ”€â”€ judge.sh              # Main CLI entry point
â”œâ”€â”€ run-all-tests.sh         # Test runner with snapshot support
â”œâ”€â”€ setup-snapshots.sh       # Snapshot initialization
â”œâ”€â”€ snapshot-tool.sh         # Snapshot management utility
â”œâ”€â”€ test-helpers.sh          # Testing utilities library
â”œâ”€â”€ test-example.sh          # Example test suite
â”œâ”€â”€ examples/
â”‚   â””â”€â”€ basic_test.sh       # Standalone example test
â”œâ”€â”€ snapshots/               # Snapshot storage directory
â”œâ”€â”€ arty.yml                 # Arty.sh configuration
â”œâ”€â”€ setup.sh                 # Initial project setup
â”œâ”€â”€ README.md                # This file
â”œâ”€â”€ LICENSE                  # MIT License
â””â”€â”€ .gitignore              # Git ignore rules
```

## Usage

### Main Commands

The `judge.sh` script provides three main commands:

#### 1. `run` - Run Tests

Execute test suites with various options:

```bash
# Run all tests
./judge.sh run

# Run with verbose output
./judge.sh run -v

# Run specific test suite
./judge.sh run -t example

# Update master snapshots
./judge.sh run -u

# Run integration tests
./judge.sh run -i

# Combine options
./judge.sh run -v -u -t my-test
```

**Options:**
- `-u, --update-snapshots` - Update master snapshots
- `-i, --integration` - Run integration tests
- `-v, --verbose` - Enable verbose output
- `-t, --test TEST` - Run specific test suite
- `-h, --help` - Show help

#### 2. `setup` - Initialize Snapshots

Run once to create initial master snapshots:

```bash
./judge.sh setup
```

This will:
1. Run all test suites
2. Create master snapshot files
3. Save them in `snapshots/` directory

**Important:** Commit master snapshots to git!

```bash
git add snapshots/*_master.log
git commit -m "Add initial test snapshots"
```

#### 3. `snap` - Manage Snapshots

Utility for snapshot management:

```bash
# List all snapshots
./judge.sh snap list

# Show latest snapshot for a test
./judge.sh snap show example

# Compare latest with master
./judge.sh snap diff example

# Show statistics
./judge.sh snap stats

# Clean old snapshots (older than 7 days)
./judge.sh snap clean

# Clean older than N days
./judge.sh snap clean 14
```

## Writing Tests

### Test File Structure

Create test files with the pattern `test-*.sh`:

```bash
#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/test-helpers.sh"

# Test suite name
log_section "My Test Suite"

# Setup (creates temp directories, etc.)
setup_test_env

# ============================================================================
# YOUR TESTS HERE
# ============================================================================

log_test "Test 1: String equality"
assert_equals "expected" "expected" "Should match"

log_test "Test 2: File operations"
echo "content" > "${TEMP_DIR}/test.txt"
assert_file_exists "${TEMP_DIR}/test.txt" "File should exist"

log_test "Test 3: String contains"
output="Hello World"
assert_contains "$output" "World" "Should contain World"

log_test "Test 4: Command success"
assert_true "[ 1 -eq 1 ]" "Should be true"

# ============================================================================
# CLEANUP
# ============================================================================

cleanup_test_env
print_test_summary

exit $?
```

### Available Assertions

**Equality & Comparison:**
```bash
assert_equals "expected" "actual" "Test description"
```

**String Operations:**
```bash
assert_contains "haystack" "needle" "Should contain needle"
assert_not_contains "haystack" "needle" "Should not contain"
```

**File System:**
```bash
assert_file_exists "/path/to/file" "File should exist"
assert_directory_exists "/path/to/dir" "Directory should exist"
```

**Exit Codes:**
```bash
command_to_test
assert_exit_code 0 $? "Command should succeed"
```

**Boolean:**
```bash
assert_true "test -f file.txt" "File test should pass"
assert_false "test -f missing.txt" "Should not exist"
```

### Logging Functions

```bash
log_section "Section Title"          # Major section separator
log_test "Running test X"            # Test announcement
log_pass "Test passed"               # Success message
log_fail "Test failed"               # Failure message
log_info "Information"               # Info message
log_warning "Warning message"        # Warning
log_error "Error occurred"           # Error message
log_success "Operation successful"   # Success indicator
```

## Snapshot Testing

### How Snapshots Work

1. **First Run** - Creates master snapshots
2. **Subsequent Runs** - Compares output against masters
3. **Differences Detected** - Test fails, shows diff
4. **Update Mode** - Overwrites master snapshots

### Snapshot Files

- `*_master.log` - Reference snapshots (commit to git)
- `*_YYYYMMDD_HHMMSS.log` - Timestamped runs (temporary)

### Snapshot Workflow

```bash
# 1. Create initial snapshots
./judge.sh setup

# 2. Review and commit
git add snapshots/*_master.log
git commit -m "Initial snapshots"

# 3. Normal test runs compare against masters
./judge.sh run

# 4. When output legitimately changes, update
./judge.sh run -u

# 5. Review changes
./judge.sh snap diff test-name

# 6. Commit updated snapshots
git add snapshots/*_master.log
git commit -m "Update snapshots after refactoring"
```

## Integration with Test Runner

To add your test to the runner, edit `run-all-tests.sh`:

```bash
# Add to TEST_FILES array
TEST_FILES=(
    "test-example.sh"
    "test-my-new-feature.sh"    # Add your test here
)

# Add to run section (if not using SPECIFIC_TEST mode)
run_test_suite "test-my-new-feature.sh" "My New Feature" "my-feature"
```

## Arty.sh Integration

This project includes an `arty.yml` configuration file for integration with the arty.sh ecosystem:

```yaml
name: "judge.sh"
version: "1.0.0"
main: "judge.sh"
scripts:
  run: "bash judge.sh run"
  setup: "bash judge.sh setup"
  snap: "bash judge.sh snap"
```

Run via arty.sh:
```bash
arty run judge.sh run
arty run judge.sh setup
```

## Environment Variables

**Test Configuration:**
- `VERBOSE` - Enable verbose output (0 or 1)
- `UPDATE_SNAPSHOTS` - Update mode (0 or 1)
- `RUN_INTEGRATION_TESTS` - Include integration tests (0 or 1)

**Directory Paths:**
- `SCRIPT_DIR` - Test script directory
- `PROJECT_ROOT` - Project root directory
- `SNAPSHOT_DIR` - Snapshot storage
- `TEMP_DIR` - Temporary test files

## Best Practices

1. **Descriptive Test Names** - Make test descriptions clear
2. **Setup & Cleanup** - Always use `setup_test_env` and `cleanup_test_env`
3. **Commit Snapshots** - Keep master snapshots in version control
4. **Review Diffs** - Check snapshot differences before updating
5. **Isolate Tests** - Each test should be independent
6. **Use Temp Dir** - Store test artifacts in `${TEMP_DIR}`

## Troubleshooting

**Tests fail with snapshot mismatch:**
```bash
# View the difference
./judge.sh snap diff test-name

# If change is expected, update
./judge.sh run -u
```

**Need to see detailed output:**
```bash
# Run with verbose flag
./judge.sh run -v
```

**Snapshots accumulating:**
```bash
# Clean old snapshots
./judge.sh snap clean 7
```

**Script not executable:**
```bash
# Run setup again
./setup.sh
```

## Examples

### Example 1: Simple Test

```bash
#!/usr/bin/env bash
source "$(dirname "$0")/test-helpers.sh"

log_section "Simple Tests"
setup_test_env

assert_equals "hello" "hello" "Strings match"
assert_true "[ 2 -gt 1 ]" "Math works"

cleanup_test_env
print_test_summary
```

### Example 2: File Testing

```bash
#!/usr/bin/env bash
source "$(dirname "$0")/test-helpers.sh"

log_section "File Tests"
setup_test_env

# Create test file
echo "test" > "${TEMP_DIR}/file.txt"
assert_file_exists "${TEMP_DIR}/file.txt" "File created"

# Check content
content=$(cat "${TEMP_DIR}/file.txt")
assert_equals "test" "$content" "Content matches"

cleanup_test_env
print_test_summary
```

### Example 3: Command Testing

```bash
#!/usr/bin/env bash
source "$(dirname "$0")/test-helpers.sh"

log_section "Command Tests"
setup_test_env

# Test command output
output=$(echo "Hello World")
assert_contains "$output" "World" "Output contains World"

# Test exit codes
true
assert_exit_code 0 $? "True command succeeds"

cleanup_test_env
print_test_summary
```

## Contributing

1. Add new test files following the naming pattern
2. Update `run-all-tests.sh` to include new tests
3. Run tests before committing
4. Update snapshots when output changes
5. Document new assertions or utilities

## License

MIT License - see LICENSE file for details

## Support

For issues or questions:
- Check existing snapshots: `./judge.sh snap list`
- Review test output: `./judge.sh run -v`
- See examples: `./examples/basic_test.sh`

Generated by [hammer.sh](https://github.com/your-org/hammer.sh) using the judge template.
